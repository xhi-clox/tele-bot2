<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Firebase (match admin panel compat SDKs) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src='//libtl.com/sdk.js' data-zone='9818146' data-sdk='show_9818146'></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>AdLancer - Earn Money Watching Ads</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* Modern Color Palette */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fc;
      --bg-tertiary: #edf2f7;
      --bg-card: #ffffff;
      --accent-primary: #7e57c2;
      --accent-secondary: #5e35b1;
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --text-tertiary: #a0aec0;
      --success: #38a169;
      --warning: #d69e2e;
      --error: #e53e3e;
      --border-radius: 16px;
      --border-radius-sm: 12px;
      --border-radius-lg: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.05);
      --sidebar-width: 280px;
      --header-height: 60px;
    }

    /* Dark Mode */
    body.dark-mode {
      --bg-primary: #121826;
      --bg-secondary: #1a202c;
      --bg-tertiary: #2d3748;
      --bg-card: #1e293b;
      --text-primary: #e2e8f0;
      --text-secondary: #a0aec0;
      --text-tertiary: #718096;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      transition: var(--transition);
      line-height: 1.5;
    }

    /* App Layout */
    .app-wrapper {
      max-width: 480px;
      margin: 0 auto;
      position: relative;
      background-color: var(--bg-primary);
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-card);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-sm);
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .app-logo {
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--accent-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-logo i {
      color: var(--accent-primary);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .theme-toggle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 1.1rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
    }

    .theme-toggle:hover {
      background: var(--bg-tertiary);
      color: var(--accent-primary);
    }

    /* Profile Section - Compact Design */
    .profile-section {
      padding: 16px;
      margin-top: 0;
    }

    .profile-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid var(--bg-tertiary);
    }

    .profile-header {
      padding: 20px 20px 16px;
      display: flex;
      align-items: center;
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 16px;
      border: 3px solid var(--bg-primary);
      box-shadow: var(--shadow-sm);
      background: linear-gradient(120deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .verified-badge {
      color: var(--success);
      font-size: 0.8rem;
    }

    .edit-name-btn {
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 0.8rem;
      transition: var(--transition);
      margin-left: 4px;
    }

    .edit-name-btn:hover {
      color: var(--accent-primary);
    }

    .points-display {
      display: inline-flex;
      align-items: center;
      background: rgba(126, 87, 194, 0.1);
      padding: 6px 12px;
      border-radius: 20px;
      color: var(--accent-primary);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .points-display i {
      margin-right: 6px;
      color: var(--accent-primary);
    }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--bg-tertiary);
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      overflow: hidden;
    }

    .stat-item {
      background: var(--bg-card);
      padding: 12px;
      text-align: center;
      position: relative;
    }

    .stat-item:not(:last-child)::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 60%;
      width: 1px;
      background: var(--bg-tertiary);
    }

    .stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent-primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Content Section */
    .content-section {
      padding: 0 16px 80px;
    }

    .section-title {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .section-title i {
      margin-right: 10px;
      color: var(--accent-primary);
      font-size: 1rem;
      background: rgba(126, 87, 194, 0.1);
      width: 32px;
      height: 32px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Task Cards */
    .task-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      border: 1px solid var(--bg-tertiary);
    }

    .task-card:active {
      transform: scale(0.98);
    }

    .task-header {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }

    .task-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(126, 87, 194, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: var(--accent-primary);
      font-size: 1.1rem;
    }

    .task-title {
      font-weight: 600;
      flex: 1;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .reward-badge {
      background: rgba(214, 158, 46, 0.1);
      color: var(--warning);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .task-description {
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.5;
      font-size: 0.9rem;
    }

    .progress-container {
      margin-bottom: 16px;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      border-radius: var(--border-radius-sm);
      border: none;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      text-decoration: none;
      font-family: 'Inter', sans-serif;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: 0 4px 12px rgba(126, 87, 194, 0.25);
    }

    .btn-primary:active {
      transform: translateY(2px);
      box-shadow: 0 2px 8px rgba(126, 87, 194, 0.3);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--bg-tertiary);
    }

    .btn-secondary:active {
      background: var(--bg-tertiary);
    }

    .btn-disabled {
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      cursor: not-allowed;
    }

    /* Input Groups */
    .input-group {
      margin-bottom: 18px;
    }

    .input-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .input-field {
      width: 100%;
      padding: 14px 16px;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--bg-tertiary);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: var(--transition);
    }

    .input-field:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(126, 87, 194, 0.2);
    }

    .select-field {
      width: 100%;
      padding: 14px 16px;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--bg-tertiary);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.95rem;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a0aec0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 16px;
    }

    /* Status Messages */
    .status-message {
      text-align: center;
      margin-top: 16px;
      font-size: 0.9rem;
      min-height: 20px;
      padding: 12px;
      border-radius: var(--border-radius-sm);
    }

    .success-message {
      background: rgba(56, 161, 105, 0.1);
      color: var(--success);
      border: 1px solid rgba(56, 161, 105, 0.2);
    }

    .error-message {
      background: rgba(229, 62, 62, 0.1);
      color: var(--error);
      border: 1px solid rgba(229, 62, 62, 0.2);
    }

    /* Referral Section */
    .referral-container {
      background: var(--bg-secondary);
      border-radius: var(--border-radius-sm);
      padding: 18px;
      margin-bottom: 16px;
      border: 1px dashed var(--bg-tertiary);
    }

    .referral-input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    .referral-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--bg-tertiary);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .copy-btn {
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border: none;
      border-radius: var(--border-radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.9rem;
      width: 100%;
    }

    .copy-btn:active {
      transform: translateY(2px);
    }

    /* For larger screens, change back to row layout */
    @media (min-width: 400px) {
      .referral-input-group {
        flex-direction: row;
      }

      .referral-input {
        flex: 1;
      }

      .copy-btn {
        width: auto;
      }
    }

    /* Referred Users */
    .referred-users {
      margin-top: 20px;
    }

    .user-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(126, 87, 194, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: var(--accent-primary);
      font-size: 1rem;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .user-code {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 0;
      color: var(--text-secondary);
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 12px;
      color: var(--accent-primary);
      opacity: 0.5;
    }

    /* Ad Modal */
    .ad-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .ad-modal-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .ad-modal {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 380px;
      padding: 24px;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s ease;
      box-shadow: var(--shadow);
      border: 1px solid var(--bg-tertiary);
    }

    .ad-modal-overlay.show .ad-modal {
      transform: scale(1);
    }

    .ad-modal-title {
      font-size: 1.2rem;
      margin-bottom: 16px;
      color: var(--accent-primary);
      font-weight: 600;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--bg-tertiary);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      margin: 20px auto;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .ad-status {
      margin: 15px 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: 30px;
      box-shadow: var(--shadow);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      border: 1px solid var(--bg-tertiary);
      text-align: center;
      max-width: 80%;
    }

    .toast.show {
      opacity: 1;
      bottom: 90px;
    }

    /* Referral Stats */
    .referral-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--bg-tertiary);
    }

    .stat-card {
      text-align: center;
      flex: 1;
      position: relative;
      padding: 8px;
    }

    .stat-card:not(:last-child)::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 70%;
      width: 1px;
      background: var(--bg-tertiary);
    }

    .stat-number {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent-primary);
    }

    .stat-title {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Developer Footer */
    .developer-footer {
      text-align: center;
      padding: 20px;
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 30px;
    }

    .developer-link {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
    }

    .developer-link:hover {
      color: var(--accent-secondary);
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 32px);
      max-width: 480px;
      background: var(--bg-card);
      border: 1px solid var(--bg-tertiary);
      border-radius: 16px;
      box-shadow: var(--shadow);
      z-index: 1000;
      padding: 8px 10px;
      backdrop-filter: blur(6px);
    }

    .bottom-nav .nav-list {
      display: flex;
      align-items: center;
      justify-content: space-between;
      list-style: none;
      gap: 6px;
    }

    .bottom-nav .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      text-decoration: none;
      color: var(--text-primary);
      border-radius: 12px;
      transition: var(--transition);
    }

    .bottom-nav .nav-item .nav-icon {
      margin: 0 0 6px 0;
      font-size: 1.2rem;
    }

    .bottom-nav .nav-item .nav-label {
      font-size: 0.75rem;
      font-weight: 600;
    }

    .bottom-nav .nav-item.active {
      background: rgba(126, 87, 194, 0.1);
      color: var(--accent-primary);
    }

    .bottom-nav .nav-item:hover:not(.active) {
      background: var(--bg-secondary);
    }

    /* NEW: Bonus Section Styling */
    .bonus-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 20px;
    }

    .bonus-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 18px;
      display: flex;
      align-items: center;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--bg-tertiary);
      transition: var(--transition);
    }

    .bonus-card:active {
      transform: scale(0.98);
    }

    .bonus-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: rgba(126, 87, 194, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      color: var(--accent-primary);
      font-size: 1.3rem;
    }

    .bonus-content {
      flex: 1;
    }

    .bonus-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .bonus-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .bonus-action {
      margin-left: 10px;
    }

    .bonus-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .bonus-btn.primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .bonus-btn.secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--bg-tertiary);
    }

    .bonus-btn.claimed {
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      cursor: not-allowed;
    }

    .bonus-reward {
      display: inline-flex;
      align-items: center;
      background: rgba(56, 161, 105, 0.1);
      color: var(--success);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 5px;
    }

    .bonus-reward i {
      margin-right: 4px;
      font-size: 0.7rem;
    }

    /* Responsive Adjustments */
    @media (max-width: 360px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
      }

      .profile-avatar {
        margin-right: 0;
        margin-bottom: 12px;
      }

      .profile-stats {
        grid-template-rows: 1fr;
      }

      .stat-item:not(:last-child)::after {
        display: none;
      }

      .stat-item {
        border-bottom: 1px solid var(--bg-tertiary);
      }

      .stat-item:last-child {
        border-bottom: none;
      }

      .bonus-card {
        flex-direction: column;
        text-align: center;
      }

      .bonus-icon {
        margin-right: 0;
        margin-bottom: 12px;
      }

      .bonus-action {
        margin-left: 0;
        margin-top: 12px;
      }
    }

    /* Animation for elements */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .task-card,
    .profile-card,
    .bonus-card {
      animation: fadeIn 0.4s ease forwards;
    }

    /* Pulse animation for buttons */
    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.03);
      }

      100% {
        transform: scale(1);
      }
    }

    .btn-pulse {
      animation: pulse 2s infinite;
    }

    /* Responsive tweaks for bottom nav and stats */
    @media (max-width: 360px) {
      .bottom-nav .nav-item .nav-label { display: none; }
      .bottom-nav .nav-item { padding: 10px 4px; }
    }
    @media (min-width: 481px) {
      .bottom-nav { max-width: 480px; }
    }
    /* Chart styles aligned with dashboard */
    .chart-card { background: var(--bg-card); border:1px solid var(--bg-tertiary); border-radius:16px; padding:12px 16px; box-shadow: var(--shadow-sm); overflow: hidden; }
    .chart-title { font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; font-size: 0.95rem; }
    .chart-wrapper { position: relative; width: 100%; height: 240px; }
    .chart-canvas { width: 100% !important; height: 100% !important; display: block; }
    @media (max-width: 400px) { .chart-wrapper { height: 200px; } }
  </style>
</head>

<body class="dark-mode">
  <div class="app-wrapper">
    <!-- Header -->
    <div class="header">
      <div class="app-logo">
        <i class="fas fa-coins"></i>
        <span>AdLancer</span>
      </div>
      <div class="header-actions">
        <button class="theme-toggle" id="themeToggle">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>

    <!-- Profile Section -->
    <div class="profile-section">
      <div class="profile-card">
        <div class="profile-header">
          <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png"
            alt="Profile" class="profile-avatar" id="profileAvatar">
          <div class="profile-info">
            <h2 class="profile-name" id="profileNameDisplay">
              Guest User
              <i class="fas fa-check-circle verified-badge"></i>
              <button class="edit-name-btn" id="editNameBtn">
                <i class="fas fa-pencil-alt"></i>
              </button>
            </h2>
            <div class="points-display" id="userPointsDisplay">
              <i class="fas fa-coins"></i>
              <span>0 Points</span>
            </div>
          </div>
        </div>
        <div class="profile-stats">
          <div class="stat-item">
            <div class="stat-value" id="adsWatchedToday">0</div>
            <div class="stat-label">Today</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="adsLeftToday">5000</div>
            <div class="stat-label">Left</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="totalAdsWatched">0</div>
            <div class="stat-label">Total</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Content Section -->
    <div class="content-section" id="mainContent">
      <!-- Content will be dynamically loaded here -->
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="bottomNav">
      <ul class="nav-list">
        <li>
          <a href="#" class="nav-item active" data-page="home">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <div class="nav-label">Home</div>
          </a>
        </li>
        <li>
          <a href="#" class="nav-item" data-page="bonus">
            <div class="nav-icon"><i class="fas fa-gem"></i></div>
            <div class="nav-label">Bonus</div>
          </a>
        </li>
        <li>
          <a href="#" class="nav-item" data-page="withdraw">
            <div class="nav-icon"><i class="fas fa-credit-card"></i></div>
            <div class="nav-label">Withdraw</div>
          </a>
        </li>
        <li>
          <a href="#" class="nav-item" data-page="referral">
            <div class="nav-icon"><i class="fas fa-user-astronaut"></i></div>
            <div class="nav-label">Referral</div>
          </a>
        </li>
        <li>
          <a href="#" class="nav-item" data-page="statistics">
            <div class="nav-icon"><i class="fas fa-chart-bar"></i></div>
            <div class="nav-label">Statistics</div>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Ad Modal -->
    <div class="ad-modal-overlay" id="adModal">
      <div class="ad-modal">
        <h3 class="ad-modal-title" id="adModalTitle">Loading Ad...</h3>
        <div class="spinner" id="adSpinner"></div>
        <p class="ad-status" id="adStatusMessage">Please wait while we load the ad</p>
        <button class="btn btn-primary" id="adCloseBtn" style="display: none;">Close & Claim Reward</button>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
  </div>

  <!-- JavaScript -->
  <script>
    // === Firebase Initialization (synchronized with admin panel) ===
    const firebaseConfig = {
      // Replace with the same config you put in adminp.html
      apiKey: "AIzaSyBJdfIANk4BLn4PaQhH2n45kMRkvAZ-jM4",
      authDomain: "telebot-xhiclox.firebaseapp.com",
      projectId: "telebot-xhiclox",
      storageBucket: "telebot-xhiclox.firebasestorage.app",
      messagingSenderId: "246768497610",
      appId: "1:246768497610:web:69de7ab2ed0b7cdf145533"
    };
    try {
      if (!firebase.apps?.length) {
        firebase.initializeApp(firebaseConfig);
      }
    } catch (e) { console.warn('Firebase init failed (index):', e); }
    const db = (typeof firebase !== 'undefined' && firebase.firestore) ? firebase.firestore() : null;

    // Configuration - Load from localStorage or use defaults
    let APP_NAME = "AdLancer";
    const defaultSettings = {
      pointsPerAd: 5,
      dailyAdLimit: 5000,
      minWithdrawalPoints: 400,
      referrerBonus: 10,
      refereeBonus: 5
    };

    // Make these variables dynamic so they can be updated
    let settings = JSON.parse(localStorage.getItem('galaxyEarnSettings')) || defaultSettings;
    let ADS_PER_DAY_LIMIT = settings.dailyAdLimit || 5000;
    let POINTS_PER_AD = settings.pointsPerAd || 5;
    let MIN_WITHDRAW_POINTS = settings.minWithdrawalPoints || 400;
    let REFERRAL_BONUS_REFERRER = settings.referrerBonus || 10;
    let REFERRAL_BONUS_REFEREE = settings.refereeBonus || 5;
    let MONETAG_AD_FUNCTION_NAME = 'show_9818146';
    let TELEGRAM_BOT_TOKEN = "7525170440:AAFF9DO5-OEAdwlo5nrLcM0XFc16Juuh-qw";
    let TELEGRAM_CHAT_ID = "8314434724";
    let DEVELOPER_TELEGRAM_PROFILE_LINK = "";
    let DEVELOPER_WEBSITE_LINK = "";
    let OFFICIAL_CHANNEL_LINK = "";
    let SUPPORT_GROUP_LINK = "";
    let REFERRAL_BOT_LINK = "https://monetag.com/?ref_id=zVQj";
    let adMinimumWatchTime = 15000; // 15 seconds in milliseconds
    const BONUS_CHANNELS = [
      { id: 'tg_official_channel', name: 'Official Channel', link: OFFICIAL_CHANNEL_LINK, reward: 5, icon: 'fab fa-telegram-plane' },
      { id: 'tg_support_group', name: 'Support Group', link: SUPPORT_GROUP_LINK, reward: 5, icon: 'fas fa-headset' },
      { id: 'tg_community', name: 'Telegram Community', link: " ", reward: 5, icon: 'fab fa-telegram' },
      { id: 'wa_community', name: 'Youtube Community', link: " ", reward: 10, icon: 'fab fa-youtube' }
    ];

    // Deprecated custom API base (kept for backward compatibility)
    const STORED_API_BASE = localStorage.getItem('API_BASE') || '';
    const DEFAULT_PROJECT_URL = '';
    const SHOULD_USE_PROJECT_URL = location.host.endsWith('t.me') || location.protocol === 'file:';
    const API_BASE = (SHOULD_USE_PROJECT_URL ? (STORED_API_BASE || DEFAULT_PROJECT_URL) : location.origin) || location.origin;
    window.setApiBase = function (url) { try { localStorage.setItem('API_BASE', url); } catch (e) { } };

    // DOM Elements
    const themeToggleBtn = document.getElementById('themeToggle');
    const profileNameDisplay = document.getElementById('profileNameDisplay');
    const profileAvatar = document.getElementById('profileAvatar');
    const editNameBtn = document.getElementById('editNameBtn');
    const userPointsDisplay = document.getElementById('userPointsDisplay');
    const adsWatchedTodayEl = document.getElementById('adsWatchedToday');
    const adsLeftTodayEl = document.getElementById('adsLeftToday');
    const totalAdsWatchedEl = document.getElementById('totalAdsWatched');
    const mainContent = document.getElementById('mainContent');
    const adModal = document.getElementById('adModal');
    const adModalTitle = document.getElementById('adModalTitle');
    const adSpinner = document.getElementById('adSpinner');
    const adStatusMessage = document.getElementById('adStatusMessage');
    const adCloseBtn = document.getElementById('adCloseBtn');
    const toast = document.getElementById('toast');
    const navItems = document.querySelectorAll('.nav-item');
    let statisticsUnsubscribe = null;

    // Current user state
    let currentUser = {
      name: 'Loading...',
      telegramId: null,
      photoUrl: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png',
      points: 0,
      adsWatchedToday: 0,
      totalAdsWatchedLifetime: 0,
      lastAdWatchDate: null,
      claimedBonuses: [],
      referralCode: '',
      referredBy: null,
      referredUsers: []
    };
    // Track current page
    let currentPage = 'home';
    function renderCurrentPage() {
      const pageRenderers = {
        'home': renderHomePage,
        'bonus': renderBonusPage,
        'withdraw': renderWithdrawPage,
        'referral': renderReferralPage,
        'statistics': renderStatisticsPage
      };
      if (pageRenderers[currentPage]) pageRenderers[currentPage]();
      updateUI();
    }

    // Show toast notification
    function showToast(message, duration = 3000) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // Generate a unique device ID for each user
    function generateDeviceId() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Generate a referral code
    function generateReferralCode() {
      return Math.random().toString(36).substring(2, 10).toUpperCase();
    }

    // Helpers to map between local user object and Firestore schema used in admin panel
    function splitName(full) {
      const name = (full || '').trim();
      if (!name) return { firstName: '', lastName: '' };
      const parts = name.split(/\s+/);
      return { firstName: parts[0] || '', lastName: parts.slice(1).join(' ') || '' };
    }

    function userToFirestoreDoc(deviceId, user) {
      const names = splitName(user.name);
      return {
        firstName: names.firstName,
        lastName: names.lastName,
        photoUrl: user.photoUrl || '',
        telegramId: user.telegramId || null,
        points: user.points || 0,
        adsWatchedToday: user.adsWatchedToday || 0,
        totalAdsWatchedLifetime: user.totalAdsWatchedLifetime || 0,
        lastAdWatchDate: user.lastAdWatchDate || null,
        referralCode: user.referralCode || '',
        referredBy: user.referredBy || null,
        referrals: Array.isArray(user.referredUsers) ? user.referredUsers : [],
        status: 'active',
        joinDate: user.joinDate || new Date().toISOString(),
        lastActive: new Date().toISOString(),
        deviceId: deviceId
      };
    }

    function firestoreDocToUser(doc) {
      const data = doc || {};
      return {
        name: [data.firstName || '', data.lastName || ''].filter(Boolean).join(' ') || 'Guest User',
        telegramId: data.telegramId || null,
        photoUrl: data.photoUrl || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png',
        points: data.points || 0,
        adsWatchedToday: data.adsWatchedToday || 0,
        totalAdsWatchedLifetime: data.totalAdsWatchedLifetime || 0,
        lastAdWatchDate: data.lastAdWatchDate || null,
        claimedBonuses: Array.isArray(data.claimedBonuses) ? data.claimedBonuses : [],
        referralCode: data.referralCode || generateReferralCode(),
        referredBy: data.referredBy || null,
        referredUsers: Array.isArray(data.referrals) ? data.referrals : [],
        status: data.status || 'active'
      };
    }

    // Show banned message and disable app functionality
    function showBannedMessage() {
      document.body.innerHTML = `
        <div style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          background: var(--bg-primary);
          color: var(--text-primary);
          font-family: 'Inter', sans-serif;
          padding: 20px;
          text-align: center;
        ">
          <div style="
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow);
            border: 1px solid var(--bg-tertiary);
          ">
            <div style="
              width: 80px;
              height: 80px;
              border-radius: 50%;
              background: rgba(229, 62, 62, 0.1);
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 0 auto 20px;
              color: var(--error);
              font-size: 2rem;
            ">
              <i class="fas fa-ban"></i>
            </div>
            <h1 style="
              font-size: 1.5rem;
              font-weight: 700;
              margin-bottom: 10px;
              color: var(--error);
            ">Account Suspended</h1>
            <p style="
              color: var(--text-secondary);
              line-height: 1.5;
              margin-bottom: 20px;
            ">Your account has been temporarily suspended. Please contact support for assistance.</p>
            <div style="
              background: rgba(229, 62, 62, 0.1);
              border: 1px solid rgba(229, 62, 62, 0.2);
              border-radius: 8px;
              padding: 15px;
              margin-top: 20px;
            ">
              <p style="
                font-size: 0.9rem;
                color: var(--error);
                margin: 0;
              ">If you believe this is an error, please contact our support team.</p>
            </div>
          </div>
        </div>
      `;
    }

    // Load user state from Firestore (preferred), fallback to localStorage, also Telegram WebApp mapping
    async function loadUserState() {
      let deviceId = localStorage.getItem('galaxyEarnDeviceId');
      if (!deviceId) {
        deviceId = generateDeviceId();
        localStorage.setItem('galaxyEarnDeviceId', deviceId);
      }

      try {
        // If Telegram user, try to map to existing user by telegramId
        if (db && window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user) {
          const tgUser = Telegram.WebApp.initDataUnsafe.user;
          const snapshot = await db.collection('users').where('telegramId', '==', tgUser.id).limit(1).get();
          if (!snapshot.empty) {
            const doc = snapshot.docs[0];
            localStorage.setItem('galaxyEarnDeviceId', doc.id);
            deviceId = doc.id;
            currentUser = firestoreDocToUser(doc.data());
            
            // Check if user is banned
            if (doc.data().status === 'banned') {
              showBannedMessage();
              return;
            }
          } else {
            // Create new user
            currentUser = {
              name: `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || `User${tgUser.id}`,
              telegramId: tgUser.id,
              photoUrl: tgUser.photo_url || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png',
              points: 0,
              adsWatchedToday: 0,
              totalAdsWatchedLifetime: 0,
              lastAdWatchDate: null,
              claimedBonuses: [],
              referralCode: generateReferralCode(),
              referredBy: null,
              referredUsers: [],
              joinDate: new Date().toISOString()
            };
            await saveUserState();
          }
        } else if (db) {
          // Guest device: try to load by deviceId
          const doc = await db.collection('users').doc(deviceId).get();
          if (doc.exists) {
            currentUser = firestoreDocToUser(doc.data());
            
            // Check if user is banned
            if (doc.data().status === 'banned') {
              showBannedMessage();
              return;
            }
          } else {
            currentUser = {
              name: 'Guest User',
              telegramId: null,
              photoUrl: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png',
              points: 0,
              adsWatchedToday: 0,
              totalAdsWatchedLifetime: 0,
              lastAdWatchDate: null,
              claimedBonuses: [],
              referralCode: generateReferralCode(),
              referredBy: null,
              referredUsers: [],
              joinDate: new Date().toISOString()
            };
            await saveUserState();
          }
        }
      } catch (e) {
        console.warn('Firestore load failed, using localStorage fallback:', e);
        let allUsersData = JSON.parse(localStorage.getItem('galaxyEarnAllUsers')) || {};
        if (!allUsersData[deviceId]) {
          allUsersData[deviceId] = {
            name: 'Guest User', telegramId: null,
            photoUrl: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png',
            points: 0, adsWatchedToday: 0, totalAdsWatchedLifetime: 0,
            lastAdWatchDate: null, claimedBonuses: [], referralCode: generateReferralCode(),
            referredBy: null, referredUsers: []
          };
          localStorage.setItem('galaxyEarnAllUsers', JSON.stringify(allUsersData));
        }
        currentUser = allUsersData[deviceId];
      }

      if (currentUser.photoUrl) {
        profileAvatar.src = currentUser.photoUrl;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const refCodeFromUrl = urlParams.get('start') || urlParams.get('ref');

      if (refCodeFromUrl && !currentUser.referredBy && refCodeFromUrl !== currentUser.referralCode) {
        const referrerExists = Object.values(allUsersData).some(user => user.referralCode === refCodeFromUrl);
        if (referrerExists) {
          applyReferral(refCodeFromUrl);
        } else {
          console.warn(`Referral code '${refCodeFromUrl}' from URL is not valid.`);
        }
      }

      // Check for daily reset
      const today = new Date().toLocaleDateString();
      if (currentUser.lastAdWatchDate !== today) {
        currentUser.adsWatchedToday = 0;
        currentUser.lastAdWatchDate = today;
        saveUserState();
      }

      // Reload settings to ensure they're up to date
      reloadSettings();
    }

    // Apply referral code
    async function applyReferral(referrerCode) {
      if (referrerCode === currentUser.referralCode || currentUser.referredBy) {
        return;
      }
      try {
        let referrerUserDoc = null;
        if (db) {
          const q = await db.collection('users').where('referralCode', '==', referrerCode).limit(1).get();
          if (!q.empty) referrerUserDoc = { id: q.docs[0].id, data: q.docs[0].data() };
        }
        if (referrerUserDoc) {
          const referrerUser = referrerUserDoc.data;
          currentUser.points += REFERRAL_BONUS_REFEREE;
          currentUser.referredBy = referrerCode;

          referrerUser.points = (referrerUser.points || 0) + REFERRAL_BONUS_REFERRER;
          const referralsArr = Array.isArray(referrerUser.referrals) ? referrerUser.referrals : [];
          referralsArr.push(currentUser.referralCode);

          await saveUserState();
          if (db) {
            await db.collection('users').doc(referrerUserDoc.id).set({
              points: referrerUser.points,
              referrals: referralsArr,
              lastActive: new Date().toISOString()
            }, { merge: true });
          }
          showToast(`+${REFERRAL_BONUS_REFEREE} bonus points for joining via referral!`);
          sendTelegramReferralNotification(
            currentUser.name,
            currentUser.referralCode,
            [referrerUser.firstName || '', referrerUser.lastName || ''].filter(Boolean).join(' '),
            referrerCode
          );
          updateUI();
          return;
        }
      } catch (e) {
        console.warn('Referral via Firestore failed, will try local fallback:', e);
      }

      // Fallback: localStorage lookup
      const allUsersData = JSON.parse(localStorage.getItem('galaxyEarnAllUsers')) || {};
      const referrerUser = Object.values(allUsersData).find(user => user.referralCode === referrerCode);
      if (referrerUser) {
        currentUser.points += REFERRAL_BONUS_REFEREE;
        currentUser.referredBy = referrerCode;
        referrerUser.points = (referrerUser.points || 0) + REFERRAL_BONUS_REFERRER;
        if (referrerUser.referredUsers) { referrerUser.referredUsers.push(currentUser.referralCode); }
        else { referrerUser.referredUsers = [currentUser.referralCode]; }
        const referrerDeviceId = Object.keys(allUsersData).find(id => allUsersData[id].referralCode === referrerCode);
        if (referrerDeviceId) { allUsersData[referrerDeviceId] = referrerUser; }
        await saveUserState();
        showToast(`+${REFERRAL_BONUS_REFEREE} bonus points for joining via referral!`);
        sendTelegramReferralNotification(
          currentUser.name,
          currentUser.referralCode,
          referrerUser.name,
          referrerCode
        );
        updateUI();
      } else {
        console.warn(`Referrer with code ${referrerCode} not found.`);
        showToast("Invalid referral code.");
      }
    }

    // Initialize settings in localStorage if they don't exist
    function initializeSettings() {
      const existingSettings = localStorage.getItem('galaxyEarnSettings');
      if (!existingSettings) {
        localStorage.setItem('galaxyEarnSettings', JSON.stringify(defaultSettings));
      }
    }

    // Reload settings from Firestore (preferred) or localStorage
    async function reloadSettings() {
      const local = JSON.parse(localStorage.getItem('galaxyEarnSettings')) || defaultSettings;
      settings = local;
      ADS_PER_DAY_LIMIT = settings.dailyAdLimit || 5000;
      POINTS_PER_AD = settings.pointsPerAd || 5;
      MIN_WITHDRAW_POINTS = settings.minWithdrawalPoints || 400;
      REFERRAL_BONUS_REFERRER = settings.referrerBonus || 10;
      REFERRAL_BONUS_REFEREE = settings.refereeBonus || 5;
      
      if (db) {
        try {
          // Load app settings
          const appSettingsDoc = await db.collection('settings').doc('appSettings').get();
          if (appSettingsDoc.exists) {
            const fs = appSettingsDoc.data();
            settings = Object.assign({}, settings, fs);
            localStorage.setItem('galaxyEarnSettings', JSON.stringify(settings));
            ADS_PER_DAY_LIMIT = settings.dailyAdLimit || ADS_PER_DAY_LIMIT;
            POINTS_PER_AD = settings.pointsPerAd || POINTS_PER_AD;
            MIN_WITHDRAW_POINTS = settings.minWithdrawalPoints || MIN_WITHDRAW_POINTS;
            REFERRAL_BONUS_REFERRER = settings.referrerBonus || REFERRAL_BONUS_REFERRER;
            REFERRAL_BONUS_REFEREE = settings.refereeBonus || REFERRAL_BONUS_REFEREE;
          }

          // Load task settings
          const taskSettingsDoc = await db.collection('settings').doc('taskSettings').get();
          if (taskSettingsDoc.exists) {
            const taskSettings = taskSettingsDoc.data();
            APP_NAME = taskSettings.appName || APP_NAME;
            TELEGRAM_BOT_TOKEN = taskSettings.telegramBotToken || TELEGRAM_BOT_TOKEN;
            TELEGRAM_CHAT_ID = taskSettings.telegramChatId || TELEGRAM_CHAT_ID;
            DEVELOPER_TELEGRAM_PROFILE_LINK = taskSettings.developerTelegramLink || DEVELOPER_TELEGRAM_PROFILE_LINK;
            DEVELOPER_WEBSITE_LINK = taskSettings.developerWebsiteLink || DEVELOPER_WEBSITE_LINK;
            OFFICIAL_CHANNEL_LINK = taskSettings.officialChannelLink || OFFICIAL_CHANNEL_LINK;
            SUPPORT_GROUP_LINK = taskSettings.supportGroupLink || SUPPORT_GROUP_LINK;
            REFERRAL_BOT_LINK = taskSettings.referralBotLink || REFERRAL_BOT_LINK;
          }

          // Load monetag settings
          const monetagSettingsDoc = await db.collection('settings').doc('monetagSettings').get();
          if (monetagSettingsDoc.exists) {
            const monetagSettings = monetagSettingsDoc.data();
            MONETAG_AD_FUNCTION_NAME = monetagSettings.functionName || MONETAG_AD_FUNCTION_NAME;
            adMinimumWatchTime = (monetagSettings.minWatchTime || 15) * 1000; // Convert to milliseconds
          }

          renderCurrentPage();
        } catch (e) { 
          console.warn('Error loading settings:', e);
        }
      }
      updateUI();
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();
      }

      // Function to check if all DOM elements are ready
      function checkDOMReady() {
        const requiredElements = [
          'profileNameDisplay', 'userPointsDisplay', 'adsWatchedToday',
          'adsLeftToday', 'totalAdsWatched', 'mainContent'
        ];

        const missingElements = requiredElements.filter(id => !document.getElementById(id));

        if (missingElements.length > 0) {
          console.log('Waiting for DOM elements:', missingElements);
          setTimeout(checkDOMReady, 50);
          return;
        }

        console.log('All DOM elements ready, initializing app');

        // Initialize settings first
        initializeSettings();

        // Reload settings to ensure they're current
        reloadSettings();

        // Load user state
        loadUserState();

        // Apply theme
        applyTheme(localStorage.getItem('galaxyEarnTheme') || 'dark');

        // Navigate to home page
        navigateTo('home');

        // Force update stats immediately after initialization
        setTimeout(() => {
          console.log('Running immediate stats update');
          if (typeof window.forceUpdateStats === 'function') {
            window.forceUpdateStats();
          }
        }, 200);
      }

      // Start checking for DOM readiness
      checkDOMReady();

      themeToggleBtn.addEventListener('click', toggleTheme);
      document.getElementById('editNameBtn').addEventListener('click', promptForNewName);
      adCloseBtn.addEventListener('click', closeAdModalAndReward);

      navItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const page = item.dataset.page;
          navigateTo(page);
        });
      });

      // Firestore realtime settings sync (live with admin panel)
      if (db) {
        try {
          db.collection('settings').doc('appSettings').onSnapshot(doc => {
            if (doc.exists) {
              const fs = doc.data();
              localStorage.setItem('galaxyEarnSettings', JSON.stringify(fs));
              settings = fs;
              ADS_PER_DAY_LIMIT = settings.dailyAdLimit || 5000;
              POINTS_PER_AD = settings.pointsPerAd || 5;
              MIN_WITHDRAW_POINTS = settings.minWithdrawalPoints || 400;
              REFERRAL_BONUS_REFERRER = settings.referrerBonus || 10;
              REFERRAL_BONUS_REFEREE = settings.refereeBonus || 5;
              renderCurrentPage();
            }
          });
        } catch (e) { console.warn('Settings listener failed:', e); }
      }

      // Periodic UI update to ensure stats stay current
      setInterval(() => {
        const today = new Date().toLocaleDateString();
        if (currentUser.lastAdWatchDate !== today) {
          currentUser.adsWatchedToday = 0;
          currentUser.lastAdWatchDate = today;
          saveUserState();
          updateUI();
        }
      }, 30000); // Check every 30 seconds

      // Add global refresh function for debugging
      window.refreshApp = function () {
        console.log('Manual refresh triggered');
        reloadSettings();
        loadUserState();
        navigateTo('home');
      };

      // Add function to reset user data if needed
      window.resetUserData = function () {
        console.log('Resetting user data');
        const deviceId = localStorage.getItem('galaxyEarnDeviceId');
        let allUsersData = JSON.parse(localStorage.getItem('galaxyEarnAllUsers')) || {};
        allUsersData[deviceId] = {
          name: 'Guest User',
          telegramId: null,
          photoUrl: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png',
          points: 0,
          adsWatchedToday: 0,
          totalAdsWatchedLifetime: 0,
          lastAdWatchDate: null,
          claimedBonuses: [],
          referralCode: generateReferralCode(),
          referredBy: null,
          referredUsers: []
        };
        localStorage.setItem('galaxyEarnAllUsers', JSON.stringify(allUsersData));
        loadUserState();
        navigateTo('home');
      };

      // Debug function for Telegram Mini App
      window.debugTelegramApp = function () {
        console.log('=== TELEGRAM MINI APP DEBUG ===');
        console.log('Telegram WebApp available:', !!window.Telegram?.WebApp);
        if (window.Telegram?.WebApp) {
          console.log('Telegram WebApp data:', {
            initData: window.Telegram.WebApp.initData,
            initDataUnsafe: window.Telegram.WebApp.initDataUnsafe,
            version: window.Telegram.WebApp.version,
            platform: window.Telegram.WebApp.platform,
            colorScheme: window.Telegram.WebApp.colorScheme,
            themeParams: window.Telegram.WebApp.themeParams
          });
        }
        console.log('Current user data:', currentUser);
        console.log('Device ID:', localStorage.getItem('galaxyEarnDeviceId'));
        console.log('All users in localStorage:', JSON.parse(localStorage.getItem('galaxyEarnAllUsers') || '{}'));
      };

      // Test API connection
      window.testAPIConnection = async function () {
        console.log('=== TESTING API CONNECTION ===');
        try {
          const response = await fetch(`${API_BASE}/api/get-users`);
          console.log('API Response status:', response.status);
          const data = await response.json();
          console.log('API Response data:', data);
          return data;
        } catch (error) {
          console.error('API Connection failed:', error);
          return null;
        }
      };

      // Add function to force update stats display
      window.forceUpdateStats = function () {
        console.log('Force updating stats display');
        console.log('Current user data:', currentUser);
        console.log('Settings:', { ADS_PER_DAY_LIMIT, POINTS_PER_AD });

        const adsWatchedEl = document.getElementById('adsWatchedToday');
        const adsLeftEl = document.getElementById('adsLeftToday');
        const totalAdsEl = document.getElementById('totalAdsWatched');
        const pointsEl = document.getElementById('userPointsDisplay');

        console.log('Elements found:', {
          adsWatchedEl: !!adsWatchedEl,
          adsLeftEl: !!adsLeftEl,
          totalAdsEl: !!totalAdsEl,
          pointsEl: !!pointsEl
        });

        if (adsWatchedEl) {
          adsWatchedEl.textContent = currentUser.adsWatchedToday;
          console.log('Updated adsWatchedToday to:', currentUser.adsWatchedToday);
        }
        if (adsLeftEl) {
          const adsLeft = ADS_PER_DAY_LIMIT - currentUser.adsWatchedToday;
          adsLeftEl.textContent = adsLeft;
          console.log('Updated adsLeftToday to:', adsLeft);
        }
        if (totalAdsEl) {
          totalAdsEl.textContent = currentUser.totalAdsWatchedLifetime;
          console.log('Updated totalAdsWatched to:', currentUser.totalAdsWatchedLifetime);
        }
        if (pointsEl) {
          pointsEl.innerHTML = `<i class="fas fa-coins"></i> ${currentUser.points} Points`;
          console.log('Updated points to:', currentUser.points);
        }

        console.log('Stats update completed');
      };

      // Add a simple test function to verify elements
      window.testStats = function () {
        console.log('Testing stats elements...');
        const elements = {
          adsWatchedToday: document.getElementById('adsWatchedToday'),
          adsLeftToday: document.getElementById('adsLeftToday'),
          totalAdsWatched: document.getElementById('totalAdsWatched'),
          userPointsDisplay: document.getElementById('userPointsDisplay')
        };

        console.log('Element test results:', elements);

        // Try to set test values
        if (elements.adsWatchedToday) {
          elements.adsWatchedToday.textContent = 'TEST';
          console.log('Set adsWatchedToday to TEST');
        }
        if (elements.adsLeftToday) {
          elements.adsLeftToday.textContent = 'TEST';
          console.log('Set adsLeftToday to TEST');
        }
        if (elements.totalAdsWatched) {
          elements.totalAdsWatched.textContent = 'TEST';
          console.log('Set totalAdsWatched to TEST');
        }
        if (elements.userPointsDisplay) {
          elements.userPointsDisplay.innerHTML = '<i class="fas fa-coins"></i> TEST Points';
          console.log('Set userPointsDisplay to TEST');
        }
      };
    });

    // Sidebar functions removed (using bottom navigation)

    // Theme management
    function applyTheme(theme) {
      document.body.classList.toggle('dark-mode', theme === 'dark');
      document.body.classList.toggle('light-mode', theme === 'light');
      themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      localStorage.setItem('galaxyEarnTheme', theme);
    }

    function toggleTheme() {
      applyTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark');
    }

    // Update UI elements
    function updateUI() {
      // Check if elements exist before updating
      if (!profileNameDisplay || !userPointsDisplay || !adsWatchedTodayEl || !adsLeftTodayEl || !totalAdsWatchedEl) {
        console.error('DOM elements not found:', {
          profileNameDisplay: !!profileNameDisplay,
          userPointsDisplay: !!userPointsDisplay,
          adsWatchedTodayEl: !!adsWatchedTodayEl,
          adsLeftTodayEl: !!adsLeftTodayEl,
          totalAdsWatchedEl: !!totalAdsWatchedEl
        });
        return;
      }

      profileNameDisplay.innerHTML = `
        ${currentUser.name}
        <i class="fas fa-check-circle verified-badge"></i>
        <button class="edit-name-btn" id="editNameBtn">
          <i class="fas fa-pencil-alt"></i>
        </button>
      `;
      document.getElementById('editNameBtn').addEventListener('click', promptForNewName);

      userPointsDisplay.innerHTML = `<i class="fas fa-coins"></i> ${currentUser.points} Points`;
      adsWatchedTodayEl.textContent = currentUser.adsWatchedToday;
      adsLeftTodayEl.textContent = ADS_PER_DAY_LIMIT - currentUser.adsWatchedToday;
      totalAdsWatchedEl.textContent = currentUser.totalAdsWatchedLifetime;

      // Update home progress widgets if present
      const watchedCount = document.getElementById('watchedCount');
      const leftCount = document.getElementById('leftCount');
      const progressInner = document.getElementById('progressInner');
      if (watchedCount) watchedCount.textContent = `${currentUser.adsWatchedToday}/${ADS_PER_DAY_LIMIT} watched`;
      if (leftCount) leftCount.textContent = `${ADS_PER_DAY_LIMIT - currentUser.adsWatchedToday} left`;
      if (progressInner) {
        const percent = Math.min(100, Math.max(0, (currentUser.adsWatchedToday / ADS_PER_DAY_LIMIT) * 100));
        progressInner.style.width = `${percent}%`;
      }

      // Debug logging for UI update
      console.log('UI Updated:', {
        points: currentUser.points,
        adsWatchedToday: currentUser.adsWatchedToday,
        adsLeftToday: ADS_PER_DAY_LIMIT - currentUser.adsWatchedToday,
        totalAdsWatched: currentUser.totalAdsWatchedLifetime,
        ADS_PER_DAY_LIMIT
      });

      if (currentUser.photoUrl) {
        profileAvatar.src = currentUser.photoUrl;
      }

      const watchBtn = document.getElementById('watchDailyAdBtn');
      if (watchBtn) {
        watchBtn.disabled = (ADS_PER_DAY_LIMIT - currentUser.adsWatchedToday <= 0);
      }

      // Force update stats display as backup
      if (typeof window.forceUpdateStats === 'function') {
        window.forceUpdateStats();
      }
    }

    function promptForNewName() {
      const newName = prompt("Enter your new name:", currentUser.name);
      if (newName && newName.trim()) {
        currentUser.name = newName.trim();
        updateUI();
        saveUserState();
        showToast("Name updated successfully!");
      }
    }

    // Navigation function
    function navigateTo(page) {
      // Reload settings to ensure they're current before rendering
      reloadSettings();

      // Update active nav item
      navItems.forEach(item => {
        item.classList.remove('active');
        if (item.dataset.page === page) {
          item.classList.add('active');
        }
      });

      const pageRenderers = {
        'home': renderHomePage,
        'bonus': renderBonusPage,
        'withdraw': renderWithdrawPage,
        'referral': renderReferralPage,
        'statistics': renderStatisticsPage
      };

      // Cleanup previous listeners when switching pages
      if (statisticsUnsubscribe) { try { statisticsUnsubscribe(); } catch (e) {} statisticsUnsubscribe = null; }
      currentPage = page;
      if (pageRenderers[page]) pageRenderers[page]();
      updateUI();
    }

    // Page renderers
    function renderHomePage() {
      const adsLeft = ADS_PER_DAY_LIMIT - currentUser.adsWatchedToday;
      const progressPercent = (currentUser.adsWatchedToday / ADS_PER_DAY_LIMIT) * 100;

      mainContent.innerHTML = `
        <div class="task-card">
          <div class="task-header">
            <div class="task-icon">
              <i class="fas fa-ad"></i>
            </div>
            <div class="task-title">Watch Ads</div>
            <div class="reward-badge">+${POINTS_PER_AD}</div>
          </div>
          <p class="task-description">
            Watch short video ads to earn points. You can watch up to ${ADS_PER_DAY_LIMIT} ads per day.
          </p>
          <div class="progress-container">
            <div class="progress-text">
              <span id="watchedCount">${currentUser.adsWatchedToday}/${ADS_PER_DAY_LIMIT} watched</span>
              <span id="leftCount">${adsLeft} left</span>
            </div>
            <div class="progress-bar">
              <div class="progress" id="progressInner" style="width: ${progressPercent}%"></div>
            </div>
          </div>
          <button class="btn btn-primary" id="watchDailyAdBtn" ${adsLeft <= 0 ? 'disabled' : ''}>
            <i class="fas fa-play"></i> Watch Ad & Earn ${POINTS_PER_AD} Points
          </button>
        </div>
        <div class="task-card">
          <p style="margin-bottom: 15px; color: var(--text-secondary);">
            <i class="fas fa-info-circle"></i> Welcome to AdLancer, where you can earn money by watching ads, complete tasks, and participate in bonuses.
          </p>
          <div style="display: grid; grid-template-rows: 1fr 1fr; gap: 12px;">
            <a href="${OFFICIAL_CHANNEL_LINK}" target="_blank" class="btn btn-secondary">
              <i class="fab fa-telegram-plane"></i> Join Channel
            </a>
            <a href="${OFFICIAL_CHANNEL_LINK}" target="_blank" class="btn btn-secondary">
              <i class="fab fa-youtube"></i> YouTube
            </a>
          </div>
        </div>
        <div class="developer-footer">
          Developed by <a href="${DEVELOPER_TELEGRAM_PROFILE_LINK}" target="_blank" class="developer-link">XHI CLOX</a>
        </div>`;

      if (adsLeft > 0) {
        document.getElementById('watchDailyAdBtn').addEventListener('click', handleWatchDailyAd);
      }
    }

    function renderBonusPage() {
      let channelsHtml = BONUS_CHANNELS.map(channel => {
        const isClaimed = currentUser.claimedBonuses.includes(channel.id);
        const linkIsValid = channel.link && !channel.link.toLowerCase().includes("your_");
        return `
          <div class="bonus-card">
            <div class="bonus-icon">
              <i class="${channel.icon}"></i>
            </div>
            <div class="bonus-content">
              <div class="bonus-title">${channel.name}</div>
              <div class="bonus-description">Join our ${channel.name} to get bonus points</div>
              <div class="bonus-reward">
                <i class="fas fa-gift"></i> +${channel.reward} Points
              </div>
            </div>
            <div class="bonus-action">
              ${linkIsValid ?
            `<a href="${channel.link}" target="_blank" class="bonus-btn ${isClaimed ? 'claimed' : 'primary'}" data-channel-id="${channel.id}" data-reward="${channel.reward}" onclick="handleBonusLinkClick(event, this)">
                  ${isClaimed ? 'Claimed' : 'Join'}
                </a>` :
            `<span class="bonus-btn secondary">Coming Soon</span>`
          }
            </div>
          </div>`;
      }).join('');

      mainContent.innerHTML = `
        <h2 class="section-title">
          <i class="fas fa-gem"></i> Bonus Rewards
        </h2>
        <p class="task-description">
          Join our community channels to earn bonus points. Visit the channel and return to claim your reward.
        </p>
        <div class="bonus-grid">
          ${channelsHtml}
        </div>
        <div class="developer-footer">
          Developed by <a href="${DEVELOPER_TELEGRAM_PROFILE_LINK}" target="_blank" class="developer-link">XHI CLOX</a>
        </div>`;
    }

    function renderWithdrawPage() {
      mainContent.innerHTML = `
        <div class="task-card">
          <h2 class="section-title">
            <i class="fas fa-credit-card"></i> Withdraw
          </h2>
          <p class="task-description">
            <b>Convert your points to real money. Minimum withdrawal is ${MIN_WITHDRAW_POINTS} points.</b>
          </p>
          <div class="input-group">
            <label class="input-label">Amount (Points)</label>
            <input type="number" id="withdrawAmountInput" class="input-field" placeholder="Enter amount">
          </div>
          <div class="input-group">
            <label class="input-label">Payment Method</label>
            <select id="withdrawMethodSelect" class="select-field">
              <option value="">Select method</option>
              <option>Telegram Mini bot code 400 Points</option>
              <option>Telegram Mini Bot Code 800 Points</option>
              <option>Telegram Mini Bot Code 1500 Points</option>
              <option>Telegram Mini Bot Code 2200 Points (VIP)</option>
            </select>
          </div>
          <div class="input-group">
            <label class="input-label">Enter your Telegram Username</label>
            <input type="text" id="withdrawAccountInput" class="input-field" placeholder="Enter your account details">
          </div>
          <button class="btn btn-primary" id="submitWithdrawBtn">
            <i class="fas fa-paper-plane"></i> Submit Request
          </button>
          <p class="status-message" id="withdrawStatusMsg"></p>
        </div>
        <div class="developer-footer">
          Developed by <a href="${DEVELOPER_TELEGRAM_PROFILE_LINK}" target="_blank" class="developer-link">XHI CLOX</a>
        </div>`;
      document.getElementById('submitWithdrawBtn').addEventListener('click', handleSubmitWithdrawal);
    }

    function renderReferralPage() {
      const referralLink = `${REFERRAL_BOT_LINK}?start=${currentUser.referralCode}`;
      const referredUsersCount = currentUser.referredUsers ? currentUser.referredUsers.length : 0;

      let referredUsersListHtml = '';
      if (referredUsersCount > 0) {
        referredUsersListHtml = `
          <h3 style="margin: 20px 0 10px; font-size: 1rem; color: var(--text-secondary);">Your Referrals (${referredUsersCount})</h3>
          <div class="referred-users">`;
        const allUsersData = JSON.parse(localStorage.getItem('galaxyEarnAllUsers')) || {};
        currentUser.referredUsers.forEach(refCode => {
          const referredUser = Object.values(allUsersData).find(user => user.referralCode === refCode);
          const name = referredUser ? referredUser.name : `User ${refCode}`;
          referredUsersListHtml += `
            <div class="user-item">
              <div class="user-avatar">
                <i class="fas fa-user"></i>
              </div>
              <div class="user-info">
                <div class="user-name">${name}</div>
                <div class="user-code">${refCode}</div>
              </div>
            </div>`;
        });
        referredUsersListHtml += `</div>`;
      } else {
        referredUsersListHtml = `
          <div class="empty-state">
            <i class="fas fa-users"></i>
            <p>No referrals yet</p>
            <p style="font-size: 0.85rem; margin-top: 5px;">Share your link to earn more</p>
          </div>`;
      }

      mainContent.innerHTML = `
        <div class="task-card">
          <h2 class="section-title">
            <i class="fas fa-user-astronaut"></i> Refer & Earn
          </h2>
          <p class="task-description">
            Invite friends and earn ${REFERRAL_BONUS_REFERRER} points for each successful referral. They'll get ${REFERRAL_BONUS_REFEREE} points too!
          </p>
          <div class="referral-container">
            <label class="input-label">Your Referral Code</label>
            <div class="referral-input-group">
              <input type="text" id="referralCodeDisplay" class="referral-input" value="${currentUser.referralCode}" readonly>
              <button class="copy-btn" id="copyReferralCodeBtn">Copy</button>
            </div>
            <label class="input-label">Your Referral Link</label>
            <div class="referral-input-group">
              <input type="text" id="referralLinkDisplay" class="referral-input" value="${referralLink}" readonly>
              <button class="copy-btn" id="copyReferralLinkBtn">Copy</button>
            </div>
            <button class="btn btn-secondary" id="shareReferralLinkBtn" style="margin-top: 15px; width: 100%;">
              <i class="fas fa-share-alt"></i> Share Link
            </button>
          </div>
          <div class="referral-stats">
            <div class="stat-card">
              <div class="stat-number">${REFERRAL_BONUS_REFERRER}</div>
              <div class="stat-title">Per Referral</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${referredUsersCount}</div>
              <div class="stat-title">Total</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${referredUsersCount * REFERRAL_BONUS_REFERRER}</div>
              <div class="stat-title">Earned</div>
            </div>
          </div>
          ${referredUsersListHtml}
        </div>
        <div class="developer-footer">
          Developed by <a href="${DEVELOPER_TELEGRAM_PROFILE_LINK}" target="_blank" class="developer-link">XHI CLOX</a>
        </div>`;

      document.getElementById('copyReferralCodeBtn').addEventListener('click', () => {
        const referralCodeInput = document.getElementById('referralCodeDisplay');
        referralCodeInput.select();
        document.execCommand('copy');
        showToast('Referral code copied!');
      });
      document.getElementById('copyReferralLinkBtn').addEventListener('click', () => {
        const referralLinkInput = document.getElementById('referralLinkDisplay');
        referralLinkInput.select();
        document.execCommand('copy');
        showToast('Referral link copied!');
      });
      document.getElementById('shareReferralLinkBtn').addEventListener('click', () => {
        if (navigator.share) {
          navigator.share({
            title: `${APP_NAME} - Earn Points!`,
            text: `Join ${APP_NAME} using my referral code ${currentUser.referralCode} and we both get bonus points!`,
            url: referralLink,
          }).catch((error) => console.log('Error sharing', error));
        } else {
          const referralLinkInput = document.getElementById('referralLinkDisplay');
          referralLinkInput.select();
          document.execCommand('copy');
          showToast('Link copied! Share it manually.');
        }
      });
    }

    function renderStatisticsPage() {
      mainContent.innerHTML = `
        <div class="task-card" style="overflow:hidden;">
          <h2 class="section-title"><i class="fas fa-chart-bar"></i> Statistics</h2>
          <p class="task-description">Insightful overview of user activity and performance. Updated in real-time as users engage.</p>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
            <div style="background: var(--bg-secondary); border:1px solid var(--bg-tertiary); border-radius:12px; padding:14px; text-align:center;">
              <div style="font-size:0.8rem; color: var(--text-secondary);">Total Users</div>
              <div id="statTotalUsers" style="font-size:1.4rem; font-weight:800; color: var(--accent-primary);">0</div>
            </div>
            <div style="background: var(--bg-secondary); border:1px solid var(--bg-tertiary); border-radius:12px; padding:14px; text-align:center;">
              <div style="font-size:0.8rem; color: var(--text-secondary);">Your Total Ads</div>
              <div style="font-size:1.4rem; font-weight:800; color: var(--accent-primary);">${currentUser.totalAdsWatchedLifetime}</div>
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:16px;">
            <div class="chart-card">
              <div class="chart-title">Your Activity</div>
              <div class="chart-wrapper"><canvas id="yourStatsChart" class="chart-canvas"></canvas></div>
            </div>
          </div>
          </div>
          <div style="background: var(--bg-card); border:1px solid var(--bg-tertiary); border-radius:12px; padding:14px;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
              <i class="fas fa-trophy" style="color: var(--warning);"></i>
              <div style="font-weight:700; color: var(--text-primary);">Top Users</div>
            </div>
            <div id="topUsersList" style="max-height: 300px; overflow: auto;"></div>
          </div>
        </div>
        <div class="developer-footer">
          Developed by <a href="${DEVELOPER_TELEGRAM_PROFILE_LINK}" target="_blank" class="developer-link">XHI CLOX</a>
        </div>
      `;

      // Chart setup - align days so current day is at the end
      const today = new Date();
      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const currentDayIndex = today.getDay();
      
      // Create labels array starting from 6 days ago to today
      const labels = [];
      for (let i = 6; i >= 0; i--) {
        const dayIndex = (currentDayIndex - i + 7) % 7;
        labels.push(dayNames[dayIndex]);
      }
      
      let yourChartInstance = null;

      // Render per-user activity chart
      const yourCtx = document.getElementById('yourStatsChart');
      function renderYourChart(dataPoints) {
        if (!yourCtx || !window.Chart) return;
        if (yourChartInstance) yourChartInstance.destroy();
        const safeData = Array.isArray(dataPoints) && dataPoints.length ? dataPoints : new Array(labels.length).fill(0);
        yourChartInstance = new Chart(yourCtx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Your Ads Watched',
              data: safeData,
              fill: true,
              tension: 0.35,
              backgroundColor: 'rgba(56, 161, 105, 0.25)',
              borderColor: 'rgba(56, 161, 105, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(56, 161, 105, 1)',
              pointBorderColor: '#fff',
              pointRadius: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }, ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') } },
              y: { grid: { color: 'rgba(160,174,192,0.2)' }, ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') }, beginAtZero: true }
            },
            animation: { duration: 300 },
            layout: { padding: { right: 8, left: 2, top: 4, bottom: 4 } }
          }
        });
      }

      // Update UI from user docs
      function updateStatsUIFromUsers(users) {
        const totalUsersEl = document.getElementById('statTotalUsers');
        const topUsersList = document.getElementById('topUsersList');
        if (totalUsersEl) totalUsersEl.textContent = users.length;
        const top = users
          .map(u => ({ name: [u.firstName||'', u.lastName||''].filter(Boolean).join(' ') || 'User', points: u.points || 0, totalAds: u.totalAdsWatchedLifetime || 0 }))
          .sort((a, b) => b.points - a.points)
          .slice(0, 5);
        if (topUsersList) {
          topUsersList.innerHTML = top.length ? top.map((u, idx) => `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--bg-tertiary);">
              <div style="display:flex; align-items:center; gap:10px; min-width:0;">
                <span style="width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; background: rgba(126,87,194,0.12); color: var(--accent-primary); font-weight:700; flex:0 0 auto;">${idx + 1}</span>
                <span onclick=\"showNamePopup(event, '${(u.name||'User').replace(/'/g, "&#39;")}')\" title=\"${u.name}\" style="font-weight:600; color: var(--text-primary); max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; display:inline-block;">
                  ${u.name}
                </span>
              </div>
              <span style="font-weight:700; color: var(--accent-primary); flex:0 0 auto;"><i class="fas fa-coins"></i> ${u.points}</span>
            </div>
          `).join('') : `<div class="empty-state"><i class="fas fa-users"></i><p>No users yet</p></div>`;
        }
      }

      // Listener or fallback
      if (statisticsUnsubscribe) { try { statisticsUnsubscribe(); } catch (e) {} statisticsUnsubscribe = null; }
      if (db) {
        try {
          statisticsUnsubscribe = db.collection('users').onSnapshot(snapshot => {
            const users = snapshot.docs.map(d => d.data() || {});
            updateStatsUIFromUsers(users);
            // User series from local activity
            renderYourChart(getUserWeeklySeries());
          }, err => {
            console.warn('Stats listener error, using fallback:', err);
            fallbackToLocal();
          });
        } catch (e) {
          console.warn('Stats listener setup failed:', e);
          fallbackToLocal();
        }
      } else {
        fallbackToLocal();
      }

      function fallbackToLocal() {
        const allUsersData = JSON.parse(localStorage.getItem('galaxyEarnAllUsers')) || {};
        const usersArray = Object.values(allUsersData).map(u => ({
          firstName: (u.name||'').split(' ')[0] || 'User',
          lastName: (u.name||'').split(' ').slice(1).join(' '),
          points: u.points || 0,
          totalAdsWatchedLifetime: u.totalAdsWatchedLifetime || 0
        }));
        updateStatsUIFromUsers(usersArray);
        renderYourChart(getUserWeeklySeries());
      }

      // Build user's weekly series from localStorage daily activity
      function getUserWeeklySeries() {
        const key = 'galaxyEarnUserDailyActivity';
        const data = JSON.parse(localStorage.getItem(key) || '{}');
        const today = new Date();
        const base = new Date(today);
        // Construct last 7 days data aligned with chart labels
        const series = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date(base);
          d.setDate(base.getDate() - i);
          const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
          series.push(Number(data[ymd] || 0));
        }
        return series;
      }

      // Ensure charts adapt on resize
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          try { if (yourChartInstance) yourChartInstance.resize(); } catch (e) {}
        }, 150);
      }, { passive: true });

      // Simple popup to show full name on tap
      window.showNamePopup = function(evt, name) {
        document.querySelectorAll('.name-popup').forEach(el => el.remove());
        const el = document.createElement('div');
        el.className = 'name-popup';
        el.textContent = name || '';
        el.style.position = 'fixed';
        el.style.background = getComputedStyle(document.body).getPropertyValue('--bg-card') || '#fff';
        el.style.color = getComputedStyle(document.body).getPropertyValue('--text-primary') || '#000';
        el.style.border = `1px solid ${getComputedStyle(document.body).getPropertyValue('--bg-tertiary') || '#eee'}`;
        el.style.borderRadius = '8px';
        el.style.padding = '8px 10px';
        el.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        el.style.zIndex = '3000';
        el.style.maxWidth = '80vw';
        document.body.appendChild(el);
        const padding = 8;
        const x = Math.min(window.innerWidth - el.offsetWidth - padding, evt.clientX + 12);
        const y = Math.min(window.innerHeight - el.offsetHeight - padding, evt.clientY + 12);
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        const remove = () => { try { el.remove(); } catch (e) {} document.removeEventListener('click', remove); };
        setTimeout(() => document.addEventListener('click', remove), 0);
      }
    }

    // Ad handling
    let adWatchedSuccessfully = false;
    let adRewardPending = false;
    let adStartTime = null;
    let adTimerInterval = null;

    function handleWatchDailyAd() {
      const today = new Date().toLocaleDateString();
      if (currentUser.lastAdWatchDate !== today) {
        currentUser.adsWatchedToday = 0;
        currentUser.lastAdWatchDate = today;
        saveUserState();
      }

      if (currentUser.adsWatchedToday >= ADS_PER_DAY_LIMIT) {
        showToast("Daily ad limit reached!");
        updateUI();
        return;
      }

      adWatchedSuccessfully = false;
      adRewardPending = true;
      adStartTime = Date.now();
      openAdModal("Launching Ad...");
      adSpinner.style.display = 'block';
      adCloseBtn.style.display = 'none';
      adStatusMessage.textContent = "Please wait while we load the ad";

      // Start timer to track minimum watch time
      startAdTimer();

      if (MONETAG_AD_FUNCTION_NAME && typeof window[MONETAG_AD_FUNCTION_NAME] === 'function') {
        try {
          const adPromise = window[MONETAG_AD_FUNCTION_NAME]();
          if (adPromise && typeof adPromise.then === 'function') {
            adModalTitle.textContent = "Ad Playing";
            adStatusMessage.textContent = "Please watch the full ad to claim your reward";
            adPromise.then(() => {
              adWatchedSuccessfully = true;
              if (adRewardPending) {
                adSpinner.style.display = 'none';
                adStatusMessage.textContent = "Ad completed! Close to claim your reward";
                adCloseBtn.style.display = 'block';
              }
            }).catch(error => {
              handleAdError("Ad closed too soon or error occurred. No points awarded.");
              console.error("Monetag ad error:", error);
            });
          } else {
            setTimeout(() => {
              if (adRewardPending) {
                adSpinner.style.display = 'none';
                adStatusMessage.textContent = "Ad completed! Close to claim your reward";
                adCloseBtn.style.display = 'block';
                adWatchedSuccessfully = true;
              }
            }, 7000);
          }
        } catch (error) {
          handleAdError("Error loading ad. Please try again.");
          console.error("Monetag ad execution error:", error);
        }
      } else {
        showToast("Ad service not fully integrated. Simulating ad watch...");
        adModalTitle.textContent = "Simulating Ad...";
        adStatusMessage.textContent = "Ad will finish in 5 seconds (simulation).";
        setTimeout(() => {
          if (adRewardPending) {
            adSpinner.style.display = 'none';
            adStatusMessage.textContent = "Simulated ad completed! Close to claim your reward";
            adCloseBtn.style.display = 'block';
            adWatchedSuccessfully = true;
          }
        }, 5000);
      }
    }

    function startAdTimer() {
      if (adTimerInterval) {
        clearInterval(adTimerInterval);
      }
      
      adTimerInterval = setInterval(() => {
        if (adStartTime && adRewardPending) {
          const elapsed = Date.now() - adStartTime;
          const remaining = Math.max(0, adMinimumWatchTime - elapsed);
          
          if (remaining > 0) {
            const secondsRemaining = Math.ceil(remaining / 1000);
            adStatusMessage.textContent = `Please watch the full ad to claim your reward (${secondsRemaining}s minimum)`;
          } else {
            clearInterval(adTimerInterval);
            adTimerInterval = null;
          }
        }
      }, 1000);
    }

    function stopAdTimer() {
      if (adTimerInterval) {
        clearInterval(adTimerInterval);
        adTimerInterval = null;
      }
    }

    function handleAdError(errorMessage) {
      if (adRewardPending) {
        adSpinner.style.display = 'none';
        adStatusMessage.textContent = errorMessage;
        adModalTitle.textContent = "Ad Error";
        adCloseBtn.textContent = "Close";
        adCloseBtn.style.display = 'block';
        adWatchedSuccessfully = false;
        adRewardPending = false;
      }
    }

    function openAdModal(title) {
      adModalTitle.textContent = title;
      adCloseBtn.textContent = "Close & Claim Reward";
      adModal.classList.add('show');
    }

    function closeAdModalAndReward() {
      adModal.classList.remove('show');
      stopAdTimer();
      
      if (adWatchedSuccessfully && adRewardPending) {
        // Check if minimum watch time has been met
        const elapsed = adStartTime ? Date.now() - adStartTime : 0;
        if (elapsed >= adMinimumWatchTime) {
          currentUser.points += POINTS_PER_AD;
          currentUser.adsWatchedToday++;
          currentUser.totalAdsWatchedLifetime++;
          currentUser.lastAdWatchDate = new Date().toLocaleDateString();
          // Track per-day user activity for charts
          try {
            const key = 'galaxyEarnUserDailyActivity';
            const data = JSON.parse(localStorage.getItem(key) || '{}');
            const today = new Date();
            const ymd = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            data[ymd] = Number(data[ymd] || 0) + 1;
            localStorage.setItem(key, JSON.stringify(data));
          } catch (e) {}
          updateUI();
          saveUserState();
          showToast(`+${POINTS_PER_AD} points earned!`);
        } else {
          showToast("Ad was closed before 15 seconds, no points awarded.");
        }
      } else if (adRewardPending && !adWatchedSuccessfully) {
        showToast("Ad not completed. No points awarded.");
      }
      adRewardPending = false;
      adWatchedSuccessfully = false;
      adStartTime = null;
    }

    // Bonus channel handling
    function handleBonusLinkClick(event, buttonElement) {
      const channelId = buttonElement.dataset.channelId;
      const reward = parseInt(buttonElement.dataset.reward);

      if (currentUser.claimedBonuses.includes(channelId)) {
        showToast("Bonus already claimed!");
        return;
      }

      event.preventDefault();
      const newWindow = window.open(buttonElement.href, '_blank');

      buttonElement.textContent = 'Verifying...';
      buttonElement.style.pointerEvents = 'none';

      setTimeout(() => {
        if (!currentUser.claimedBonuses.includes(channelId)) {
          currentUser.points += reward;
          currentUser.claimedBonuses.push(channelId);
          updateUI();
          saveUserState();
          buttonElement.textContent = 'Claimed';
          buttonElement.classList.add('claimed');
          showToast(`+${reward} bonus points claimed!`);
        } else {
          buttonElement.textContent = 'Claimed';
          buttonElement.classList.add('claimed');
        }
        buttonElement.style.pointerEvents = 'auto';
      }, 7000);
    }

    // Withdrawal handling
    function handleSubmitWithdrawal() {
      const amount = parseInt(document.getElementById('withdrawAmountInput').value);
      const method = document.getElementById('withdrawMethodSelect').value;
      const account = document.getElementById('withdrawAccountInput').value.trim();
      const statusMsg = document.getElementById('withdrawStatusMsg');

      statusMsg.className = 'status-message';
      statusMsg.textContent = '';

      if (isNaN(amount) || amount <= 0) {
        statusMsg.textContent = "Please enter a valid amount.";
        statusMsg.classList.add('error-message');
        return;
      }
      if (amount < MIN_WITHDRAW_POINTS) {
        statusMsg.textContent = `Minimum withdrawal is ${MIN_WITHDRAW_POINTS} points.`;
        statusMsg.classList.add('error-message');
        return;
      }
      if (amount > currentUser.points) {
        statusMsg.textContent = "You don't have enough points.";
        statusMsg.classList.add('error-message');
        return;
      }
      if (!method) {
        statusMsg.textContent = "Please select a payment method.";
        statusMsg.classList.add('error-message');
        return;
      }
      if (!account) {
        statusMsg.textContent = "Please enter your account details.";
        statusMsg.classList.add('error-message');
        return;
      }

      const escapeMarkdown = (text) => {
        return text.replace(/([_*\[\]()~`>#+\-=|{}.!])/g, '\\$1');
      };

      const withdrawalDetails = `
🔔 *𝗡𝗲𝘄 𝗪𝗶𝘁𝗵𝗱𝗿𝗮𝘄𝗮𝗹 𝗥𝗲𝗾𝘂𝗲𝘀𝘁 * 🔔
------------------------------------
🕵️ *𝗔𝗽𝗽 𝗡𝗮𝗺𝗲 :* \`${escapeMarkdown(APP_NAME)}\`
👤 *𝗨𝘀𝗲𝗿 𝗡𝗮𝗺𝗲 :* \`${escapeMarkdown(currentUser.name)}\`
💰 *𝗣𝗼𝗶𝗻𝘁𝘀 :* ${amount}
💳 *𝗠𝗲𝘁𝗵𝗼𝗱 :* ${escapeMarkdown(method)}
🏦 *𝗪𝗮𝗹𝗹𝗲𝘁 :* \`${escapeMarkdown(account)}\`
------------------------------------
♎ 𝗠𝗮𝗶𝗻 𝗕𝗮𝗹𝗮𝗻𝗰𝗲 : ${currentUser.points - amount}
👀 𝗧𝗼𝘁𝗮𝗹 𝗔𝗱𝘀 𝗪𝗮𝘁𝗰𝗵𝗲𝗱 : ${currentUser.totalAdsWatchedLifetime}
------------------------------------
⏰ *𝗪𝗶𝘁𝗵𝗱𝗿𝗮𝘄𝗮𝗹 𝗧𝗶𝗺𝗲 :* ${new Date().toLocaleString('en-GB', { timeZone: 'Asia/Dhaka' })}
      `;

      sendToTelegram(withdrawalDetails);

      // Store withdrawal request for admin panel
      const withdrawalRequest = {
        id: `${Date.now()}`,
        userName: currentUser.name,
        amount: amount,
        method: method,
        account: account,
        requestDate: new Date().toISOString(),
        status: 'pending'
      };

      let withdrawalRequests = JSON.parse(localStorage.getItem('galaxyEarnWithdrawalRequests')) || [];
      withdrawalRequests.push(withdrawalRequest);
      localStorage.setItem('galaxyEarnWithdrawalRequests', JSON.stringify(withdrawalRequests));

      // Save to Firestore for admin panel sync
      (async () => {
        try {
          if (db) {
            await db.collection('withdrawals').doc(withdrawalRequest.id).set(withdrawalRequest);
          }
        } catch (e) { console.warn('Failed to write withdrawal to Firestore:', e); }
      })();

      currentUser.points -= amount;
      updateUI();
      saveUserState();

      statusMsg.textContent = "Withdrawal request submitted successfully!";
      statusMsg.classList.add('success-message');
      document.getElementById('withdrawAmountInput').value = "";
      document.getElementById('withdrawMethodSelect').value = "";
      document.getElementById('withdrawAccountInput').value = "";
    }

    // Telegram integration
    function sendToTelegram(message) {
      if (!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN.includes("YOUR_TELEGRAM_BOT_TOKEN") || !TELEGRAM_CHAT_ID) {
        console.warn("Telegram Bot not configured. Message not sent.");
        return;
      }

      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text: message,
          parse_mode: 'MarkdownV2'
        })
      })
        .then(response => response.json())
        .then(data => {
          if (!data.ok) {
            console.warn('Telegram API error:', data.description);
            fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message.replace(/[*_`\[\]()~>#+\-=|{}.!]/g, '')
              })
            }).then(res => res.json()).then(plainData => {
              if (!plainData.ok) {
                console.error('Plain text Telegram message failed:', plainData.description);
              }
            });
          }
        })
        .catch(error => console.error('Error sending Telegram message:', error));
    }

    function sendTelegramReferralNotification(refereeName, refereeCode, referrerName, referrerCode) {
      if (!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN.includes("YOUR_TELEGRAM_BOT_TOKEN") || !TELEGRAM_CHAT_ID) {
        console.warn("Telegram Bot for referral notification not configured. Notification not sent.");
        return;
      }

      const escapeMarkdown = (text) => {
        return text.replace(/([_*\[\]()~`>#+\-=|{}.!])/g, '\\$1');
      };

      const message = `
🎉 *New Referral Bonus!* 🎉
------------------------------------
👥 *New User:* \`${escapeMarkdown(refereeName)}\` (Code: \`${escapeMarkdown(refereeCode)}\`)
🌟 *Received:* ${REFERRAL_BONUS_REFEREE} points
Referral From:
👤 *Referrer:* \`${escapeMarkdown(referrerName)}\` (Code: \`${escapeMarkdown(referrerCode)}\`)
🌟 *Received:* ${REFERRAL_BONUS_REFERRER} points
------------------------------------
⏰ *Timestamp:* ${new Date().toLocaleString('en-GB', { timeZone: 'Asia/Dhaka' })}
      `;

      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text: message,
          parse_mode: 'MarkdownV2'
        })
      })
        .then(response => response.json())
        .then(data => {
          if (!data.ok) {
            console.warn('Telegram API error for referral notification:', data.description);
            fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message.replace(/[*_`\[\]()~>#+\-=|{}.!]/g, '')
              })
            });
          }
        })
        .catch(error => console.error('Error sending referral Telegram message:', error));
    }

    // Save user state to Firestore (preferred), fallback to localStorage
    async function saveUserState() {
      const deviceId = localStorage.getItem('galaxyEarnDeviceId');
      try {
        if (db) {
          const docData = userToFirestoreDoc(deviceId, currentUser);
          await db.collection('users').doc(deviceId).set(docData, { merge: true });
        }
      } catch (error) {
        console.warn('Failed to save user to Firestore, will keep local backup:', error);
      }
      // Always keep local backup for offline usage
      let allUsersData = JSON.parse(localStorage.getItem('galaxyEarnAllUsers')) || {};
      allUsersData[deviceId] = currentUser;
      localStorage.setItem('galaxyEarnAllUsers', JSON.stringify(allUsersData));
    }
  </script>
</body>

</html>



