<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #2d3748;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>

    <div id="login-panel" class="container min-h-screen flex items-center justify-center">
        <div class="w-full max-w-sm card text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Admin Login</h1>
            <p class="text-sm text-gray-500 mb-6">Enter password to continue.</p>
            <input id="password-input" type="password" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4" placeholder="Password">
            <button id="login-button" class="w-full bg-purple-600 text-white font-semibold py-3 px-4 rounded-md hover:bg-purple-700 transition duration-300">Login</button>
            <p id="login-message" class="mt-4 text-sm text-red-500 hidden"></p>
        </div>
    </div>

    <div id="admin-dashboard" class="container hidden">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8">Admin Dashboard</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="card text-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Total Users</h2>
                <p id="total-users" class="text-4xl font-bold text-purple-600">0</p>
            </div>
            <div class="card text-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Withdrawal Requests</h2>
                <p id="withdrawal-requests-count" class="text-4xl font-bold text-red-600">0</p>
            </div>
            <div class="card text-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Top Referrals</h2>
                <p id="top-referrals-count" class="text-4xl font-bold text-green-600">0</p>
            </div>
        </div>

        <div class="card mb-8">
            <h2 class="text-2xl font-bold mb-4">Withdrawal Requests</h2>
            <div id="withdrawal-requests-list" class="overflow-x-auto">
                <p class="text-gray-500">No withdrawal requests found.</p>
            </div>
        </div>
        
        <div class="card mb-8">
            <h2 class="text-2xl font-bold mb-4">User Management</h2>
            <input type="text" id="user-search" placeholder="Search by User ID" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4">
            <div id="user-list" class="overflow-x-auto">
                <p class="text-gray-500">No users found.</p>
            </div>
        </div>

        <div class="card mb-8">
            <h2 class="text-2xl font-bold mb-4">Top Users (by Points)</h2>
            <div id="top-users-list" class="overflow-x-auto">
                <p class="text-gray-500">No top users found.</p>
            </div>
        </div>

    </div>

    <!-- Modal for confirmation messages -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal">
        <div class="bg-white rounded-xl p-8 max-w-sm w-full shadow-lg text-center">
            <p id="modal-message" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-around">
                <button id="modal-confirm" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-600 transition duration-300">Confirm</button>
                <button id="modal-cancel" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400 transition duration-300">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Password for admin panel
            const ADMIN_PASSWORD = 'admin123';

            const loginPanel = document.getElementById('login-panel');
            const passwordInput = document.getElementById('password-input');
            const loginButton = document.getElementById('login-button');
            const loginMessage = document.getElementById('login-message');
            const adminDashboard = document.getElementById('admin-dashboard');

            const totalUsersSpan = document.getElementById('total-users');
            const withdrawalRequestsCountSpan = document.getElementById('withdrawal-requests-count');
            const topReferralsCountSpan = document.getElementById('top-referrals-count');
            
            const userSearchInput = document.getElementById('user-search');
            const userListDiv = document.getElementById('user-list');
            const withdrawalRequestsListDiv = document.getElementById('withdrawal-requests-list');
            const topUsersListDiv = document.getElementById('top-users-list');
            
            // Modal elements
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm');
            const modalCancelBtn = document.getElementById('modal-cancel');

            // --- Utility Functions ---
            
            /**
             * Shows a custom confirmation modal.
             * @param {string} message The message to display.
             * @returns {Promise<boolean>} A promise that resolves to true if confirmed, false otherwise.
             */
            function showConfirmationModal(message) {
                return new Promise((resolve) => {
                    modalMessage.textContent = message;
                    confirmationModal.classList.remove('hidden');

                    modalConfirmBtn.onclick = () => {
                        confirmationModal.classList.add('hidden');
                        resolve(true);
                    };

                    modalCancelBtn.onclick = () => {
                        confirmationModal.classList.add('hidden');
                        resolve(false);
                    };
                });
            }

            // --- Data Management ---
            
            /**
             * Loads all user data from localStorage.
             * @returns {Object[]} The array of user objects.
             */
            function loadUsersData() {
                const data = localStorage.getItem('allUsersData');
                try {
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error("Failed to parse user data from localStorage:", e);
                    return [];
                }
            }

            /**
             * Saves the user data back to localStorage.
             * @param {Object[]} users The array of user objects to save.
             */
            function saveUsersData(users) {
                localStorage.setItem('allUsersData', JSON.stringify(users));
            }

            // --- Rendering Functions ---

            /**
             * Renders a message when no data is found.
             * @param {HTMLElement} container The container to render the message in.
             */
            function renderNoData(container) {
                container.innerHTML = '<p class="text-gray-500 p-4">No data found.</p>';
            }

            /**
             * Renders the main dashboard stats.
             * @param {Object[]} users The array of user objects.
             */
            function renderStats(users) {
                totalUsersSpan.textContent = users.length;
                const withdrawalRequests = users.filter(user => user.withdrawal_requests && user.withdrawal_requests.length > 0);
                withdrawalRequestsCountSpan.textContent = withdrawalRequests.length;
            }

            /**
             * Renders the list of withdrawal requests.
             * @param {Object[]} users The array of user objects.
             */
            function renderWithdrawalRequests(users) {
                const withdrawalRequests = users.flatMap(user => 
                    (user.withdrawal_requests || []).map(req => ({
                        userId: user.userId,
                        request: req
                    }))
                );

                if (withdrawalRequests.length === 0) {
                    renderNoData(withdrawalRequestsListDiv);
                    return;
                }

                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody id="withdrawal-requests-body" class="bg-white divide-y divide-gray-200"></tbody>
                `;
                
                const tbody = table.querySelector('#withdrawal-requests-body');
                withdrawalRequests.forEach(req => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 break-all">${req.userId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${req.request.amount}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${req.request.method}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 break-all">${req.request.account}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-green-600 hover:text-green-900 mr-2 approve-btn" data-user-id="${req.userId}">Approve</button>
                            <button class="text-red-600 hover:text-red-900 delete-btn" data-user-id="${req.userId}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                withdrawalRequestsListDiv.innerHTML = '';
                withdrawalRequestsListDiv.appendChild(table);

                // Add event listeners for buttons
                withdrawalRequestsListDiv.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.target.dataset.userId;
                        const confirmation = await showConfirmationModal("Are you sure you want to delete this withdrawal request?");
                        if (confirmation) {
                            deleteWithdrawalRequest(userId);
                        }
                    });
                });
            }

            /**
             * Renders the list of all users.
             * @param {Object[]} users The array of user objects.
             */
            function renderUsersList(users) {
                if (users.length === 0) {
                    renderNoData(userListDiv);
                    return;
                }

                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Points</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Referral ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Referral Count</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                `;

                const tbody = table.querySelector('#users-table-body');
                users.forEach(user => {
                    const row = document.createElement('tr');
                    const statusText = user.isBanned ? 'Banned' : 'Active';
                    const statusColor = user.isBanned ? 'text-red-600' : 'text-green-600';
                    const banBtnText = user.isBanned ? 'Unban' : 'Ban';
                    const banBtnColor = user.isBanned ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 break-all">${user.userId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.points || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 break-all">${user.referrerId || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.referralCount || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${statusText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="${banBtnColor} text-white font-semibold py-1 px-3 rounded-lg ban-btn" data-user-id="${user.userId}">${banBtnText}</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                userListDiv.innerHTML = '';
                userListDiv.appendChild(table);

                // Add event listeners for ban/unban buttons
                userListDiv.querySelectorAll('.ban-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.target.dataset.userId;
                        const usersData = loadUsersData();
                        const user = usersData.find(u => u.userId === userId);
                        if (user) {
                            const action = user.isBanned ? 'unban' : 'ban';
                            const confirmation = await showConfirmationModal(`Are you sure you want to ${action} this user?`);
                            if (confirmation) {
                                toggleBanStatus(userId);
                            }
                        }
                    });
                });
            }

            /**
             * Renders the top users by points.
             * @param {Object[]} users The array of user objects.
             */
            function renderTopUsers(users) {
                const topUsers = [...users].sort((a, b) => (b.points || 0) - (a.points || 0)).slice(0, 10);
                if (topUsers.length === 0) {
                    renderNoData(topUsersListDiv);
                    return;
                }

                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Points</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                `;

                const tbody = table.querySelector('tbody');
                topUsers.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 break-all">${user.userId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.points || 0}</td>
                    `;
                    tbody.appendChild(row);
                });

                topUsersListDiv.innerHTML = '';
                topUsersListDiv.appendChild(table);
            }

            /**
             * Updates the UI with the latest data.
             */
            function refreshDashboard() {
                const usersData = loadUsersData();
                renderStats(usersData);
                renderWithdrawalRequests(usersData);
                renderUsersList(usersData);
                renderTopUsers(usersData);
            }

            // --- Action Handlers ---

            /**
             * Toggles the ban status of a user.
             * @param {string} userId The ID of the user to toggle.
             */
            function toggleBanStatus(userId) {
                const usersData = loadUsersData();
                const user = usersData.find(u => u.userId === userId);
                if (user) {
                    user.isBanned = !user.isBanned;
                    saveUsersData(usersData);
                    refreshDashboard();
                }
            }

            /**
             * Deletes a withdrawal request for a user.
             * @param {string} userId The ID of the user.
             */
            function deleteWithdrawalRequest(userId) {
                const usersData = loadUsersData();
                const user = usersData.find(u => u.userId === userId);
                if (user) {
                    // Remove all withdrawal requests for the user for simplicity
                    user.withdrawal_requests = [];
                    saveUsersData(usersData);
                    refreshDashboard();
                }
            }

            // --- Event Listeners ---

            loginButton.addEventListener('click', () => {
                const password = passwordInput.value;
                if (password === ADMIN_PASSWORD) {
                    loginPanel.classList.add('hidden');
                    adminDashboard.classList.remove('hidden');
                    refreshDashboard();
                } else {
                    loginMessage.textContent = 'Incorrect password.';
                    loginMessage.classList.remove('hidden');
                }
            });

            // Search functionality
            userSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const usersData = loadUsersData();
                const filteredUsers = usersData.filter(user => user.userId.toLowerCase().includes(searchTerm));
                renderUsersList(filteredUsers);
            });

            // Refresh data every 5 seconds to get updates from the main app
            setInterval(refreshDashboard, 5000);
        });
    </script>
</body>
</html>
